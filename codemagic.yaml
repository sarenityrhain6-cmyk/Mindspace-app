workflows:
  android-workflow:
    name: Android Build
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      java: 21
      node: 20
    scripts:
      - name: Install dependencies
        working_directory: frontend
        script: |
          npm install --legacy-peer-deps
          npm install ajv@^8 --save --legacy-peer-deps
      - name: Setup environment
        working_directory: frontend
        script: |
          echo "REACT_APP_BACKEND_URL=https://mindspace-preview.preview.emergentagent.com" > .env
          echo "CI=false" >> .env
      - name: Build React app
        working_directory: frontend
        script: |
          CI=false npm run build
      - name: Sync Capacitor
        working_directory: frontend
        script: |
          npx cap sync android
      - name: Create keystore and sign
        working_directory: frontend/android
        script: |
          # Generate keystore
          keytool -genkeypair -v \
            -keystore app/mindspace-upload.keystore \
            -alias upload \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=MindSpace, OU=Mobile, O=MindSpace, L=City, ST=State, C=US"
          
          # Create signing config file
          echo "storeFile=mindspace-upload.keystore" > app/keystore.properties
          echo "storePassword=android" >> app/keystore.properties
          echo "keyAlias=upload" >> app/keystore.properties
          echo "keyPassword=android" >> app/keystore.properties
      - name: Build Signed Bundle
        working_directory: frontend/android
        script: |
          ./gradlew bundleRelease \
            -Pandroid.injected.signing.store.file=$(pwd)/app/mindspace-upload.keystore \
            -Pandroid.injected.signing.store.password=android \
            -Pandroid.injected.signing.key.alias=upload \
            -Pandroid.injected.signing.key.password=android
    artifacts:
      - frontend/android/app/build/outputs/bundle/release/app-release.aab
